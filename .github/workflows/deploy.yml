name: Deploy to VPS

on:
  push:
    branches:
      - main  # Deploy on push to main branch
  workflow_dispatch:  # Allow manual trigger

jobs:
    deploy:
      runs-on: ubuntu-latest

      steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Prepare deployment package
          run: |
            mkdir -p deploy-package
            cp -r Scripts deploy-package/
            cp -r Data deploy-package/ 2>/dev/null || true
            cp LinuxServer.exe deploy-package/ 2>/dev/null || true
            cp WindowsServer.exe deploy-package/ 2>/dev/null || true
            cp *.dll deploy-package/ 2>/dev/null || true
            cp -r Server deploy-package/ 2>/dev/null || true
            tar -czf deploy.tar.gz deploy-package/

        - name: Setup SSH and Deploy
          env:
            SSH_PRIVATE_KEY: ${{ secrets.VPS_SSH_KEY }}
            VPS_HOST: ${{ secrets.VPS_HOST }}
            VPS_USER: ${{ secrets.VPS_USERNAME }}
            VPS_PATH: ${{ secrets.DEPLOY_PATH }}
          run: |
            # Setup SSH
            mkdir -p ~/.ssh
            echo "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/deploy_key
            chmod 600 ~/.ssh/deploy_key
            ssh-keyscan -H "$VPS_HOST" >> ~/.ssh/known_hosts 2>/dev/null

            # Debug - show what we're connecting to
            echo "Connecting to: $VPS_USER@$VPS_HOST"
            echo "Deploy path: $VPS_PATH"

            # Test connection
            ssh -i ~/.ssh/deploy_key -o BatchMode=yes -o StrictHostKeyChecking=no "$VPS_USER@$VPS_HOST" "echo 'Connected successfully'"

            # Stop server
            echo "Stopping server..."
            ssh -i ~/.ssh/deploy_key -o BatchMode=yes -o StrictHostKeyChecking=no "$VPS_USER@$VPS_HOST" "pkill -f 'LinuxServer.exe' || true; sleep 5; pkill -9 -f 'LinuxServer.exe' || true; echo 'Server stopped'"

            # Backup
            echo "Creating backup..."
            ssh -i ~/.ssh/deploy_key -o BatchMode=yes -o StrictHostKeyChecking=no "$VPS_USER@$VPS_HOST" "cd $VPS_PATH && mkdir -p backups && cp -r Scripts backups/\$(date +%Y%m%d_%H%M%S) 2>/dev/null || true"

            # Upload
            echo "Uploading files..."
            scp -i ~/.ssh/deploy_key -o BatchMode=yes -o StrictHostKeyChecking=no deploy.tar.gz "$VPS_USER@$VPS_HOST:$VPS_PATH/"

            # Extract
            echo "Extracting files..."
            ssh -i ~/.ssh/deploy_key -o BatchMode=yes -o StrictHostKeyChecking=no "$VPS_USER@$VPS_HOST" "cd $VPS_PATH && tar -xzf deploy.tar.gz && cp -r deploy-package/* . && rm -rf deploy-package deploy.tar.gz && rm -f Scripts/Output/Scripts.CS.dll Scripts/Output/Scripts.CS.hash 2>/dev/null || true && chmod +x LinuxServer.exe"

            # Start server
            echo "Starting server..."
            ssh -i ~/.ssh/deploy_key -o BatchMode=yes -o StrictHostKeyChecking=no "$VPS_USER@$VPS_HOST" "cd $VPS_PATH && nohup mono LinuxServer.exe > server.log 2>&1 &"

            # Wait and check
            echo "Waiting for server to start..."
            sleep 30
            ssh -i ~/.ssh/deploy_key -o BatchMode=yes -o StrictHostKeyChecking=no "$VPS_USER@$VPS_HOST" "pgrep -f 'LinuxServer.exe' && echo 'Server is running' && tail -20 $VPS_PATH/server.log || (echo 'Server failed to start' && tail -50 $VPS_PATH/server.log && exit 1)"

            echo "Deployment complete!"

        - name: Cleanup
          if: always()
          run: |
            rm -f ~/.ssh/deploy_key
            rm -f deploy.tar.gz
