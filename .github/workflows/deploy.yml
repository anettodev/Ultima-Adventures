name: Deploy to VPS

on:
  push:
    branches:
      - main  # Deploy on push to main branch
  workflow_dispatch:  # Allow manual trigger

jobs:
    deploy:
      runs-on: ubuntu-latest
      env:
        VPS_HOST: ${{ secrets.VPS_HOST }}
        VPS_USER: ${{ secrets.VPS_USERNAME }}
        VPS_PATH: ${{ secrets.DEPLOY_PATH }}

      steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Prepare deployment package
          run: |
            mkdir -p deploy-package
            cp -r Scripts deploy-package/
            cp -r Data deploy-package/ 2>/dev/null || true
            cp LinuxServer.exe deploy-package/ 2>/dev/null || true
            cp WindowsServer.exe deploy-package/ 2>/dev/null || true
            cp *.dll deploy-package/ 2>/dev/null || true
            cp -r Server deploy-package/ 2>/dev/null || true
            tar -czf deploy.tar.gz deploy-package/

        - name: Setup SSH key
          env:
            SSH_PRIVATE_KEY: ${{ secrets.VPS_SSH_KEY }}
          run: |
            mkdir -p ~/.ssh
            echo "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/deploy_key
            chmod 600 ~/.ssh/deploy_key
            ssh-keyscan -H $VPS_HOST >> ~/.ssh/known_hosts 2>/dev/null

            # Test connection and verify path
            ssh -i ~/.ssh/deploy_key -o BatchMode=yes -o ConnectTimeout=10 ${VPS_USER}@${VPS_HOST} "echo 'SSH OK' && echo 'Path: ${VPS_PATH}' && ls -la ${VPS_PATH} || echo 'Path does not exist'"

        - name: Stop server
          run: |
            ssh -i ~/.ssh/deploy_key -o BatchMode=yes -o StrictHostKeyChecking=no ${VPS_USER}@${VPS_HOST} "cd ${VPS_PATH} && pkill -f 'LinuxServer.exe' || true && sleep 5 && pkill -9 -f 'LinuxServer.exe' || true && echo 'Server stopped'"

        - name: Backup current version
          run: |
            ssh -i ~/.ssh/deploy_key -o BatchMode=yes -o StrictHostKeyChecking=no ${VPS_USER}@${VPS_HOST} "cd ${VPS_PATH} && BACKUP_DIR=\"backups/\$(date +%Y%m%d_%H%M%S)\" && mkdir -p \"\$BACKUP_DIR\" && cp -r Scripts \"\$BACKUP_DIR/\" 2>/dev/null || true && echo \"Backup created\" && cd backups && ls -t | tail -n +6 | xargs -r rm -rf"

        - name: Deploy to VPS
          run: |
            scp -i ~/.ssh/deploy_key -o BatchMode=yes -o StrictHostKeyChecking=no deploy.tar.gz ${VPS_USER}@${VPS_HOST}:${VPS_PATH}/

        - name: Extract and setup files
          run: |
            ssh -i ~/.ssh/deploy_key -o BatchMode=yes -o StrictHostKeyChecking=no ${VPS_USER}@${VPS_HOST} "cd ${VPS_PATH} && tar -xzf deploy.tar.gz && cp -r deploy-package/* . && rm -rf deploy-package deploy.tar.gz && rm -f Scripts/Output/Scripts.CS.dll Scripts/Output/Scripts.CS.hash 2>/dev/null || true && chmod +x LinuxServer.exe && echo 'Files extracted'"

        - name: Start server
          run: |
            ssh -i ~/.ssh/deploy_key -o BatchMode=yes -o StrictHostKeyChecking=no ${VPS_USER}@${VPS_HOST} "cd ${VPS_PATH} && nohup mono LinuxServer.exe > server.log 2>&1 & sleep 30 && if pgrep -f 'LinuxServer.exe' > /dev/null; then echo 'Server running' && tail -20 server.log; else echo 'Server failed' && tail -50 server.log && exit 1; fi"

        - name: Cleanup
          if: always()
          run: |
            rm -f ~/.ssh/deploy_key
            rm -f deploy.tar.gz

        - name: Deployment notification
          if: success()
          run: |
            echo "Deployment completed successfully!"

        - name: Deployment failed notification
          if: failure()
          run: |
            echo "Deployment failed!"
